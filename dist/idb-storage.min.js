var idbStorage=function(e){"use strict";const t="undefined"!=typeof navigator&&/iP(hone|(o|a)d);/.test(navigator.userAgent);function n(){let e=Promise.resolve();const t={use:function(n){t.length++;const r=e.then(n).then(e=>(t.length--,e),e=>{throw t.length--,e});return e=r.catch(()=>{}),r},acquire:function(){let n;t.length++;const r=e.then(()=>n);return e=new Promise(e=>{n=e}).then(()=>{t.length--}),r},length:0};return t}function r(e){return new Promise((t,n)=>{e.onsuccess=(()=>t(e.result)),e.onerror=n})}function o({name:e,version:t,onupgradeneeded:n,indexedDB:r=a()}){if(!e)throw new Error("missing storage name");if(!r)throw new Error("missing indexedDB");let o,c=0;return{use:s,startTransaction:function(e,t,n){return s(async r=>{const o=r.transaction(e,t),[a]=await Promise.all([n(o),new Promise((e,t)=>{o.oncomplete=(()=>e()),o.onerror=t})]);return a})}};async function s(a){c++,o||(o=new Promise((o,a)=>{const c=r.open(e,t);c.onerror=a,c.onsuccess=(()=>o(c.result)),c.onupgradeneeded=n}));const s=await o;let i,u;try{u=await a(s)}catch(e){i=e}if(--c||(s.close(),o=null),i)throw i;return u}}function a(){return"undefined"!=typeof indexedDB?indexedDB:"undefined"!=typeof webkitIndexedDB?webkitIndexedDB:"undefined"!=typeof mozIndexedDB?mozIndexedDB:"undefined"!=typeof OIndexedDB?OIndexedDB:"undefined"!=typeof msIndexedDB?msIndexedDB:null}return e.createIDBStorage=function({name:e,conflictAction:a="throw",indexedDB:c}={}){const s=o({indexedDB:c,name:e,version:1,onupgradeneeded:function(e){e.oldVersion<1&&(e.target.result.createObjectStore("metadata"),e.target.result.createObjectStore("resource"))}}),i=new Map;return function({init:e,api:t,block:n}){const r={};let o,a,c,s=!1;for(const[i,d]of Object.entries(t)){const t=n.includes(i);r[i]=((...n)=>{if(!s){const t=u({fn:()=>e().catch(e=>{console.error(e),c=e}),isBlocker:!0});o=a=t,s=!0}const r=u({fn:d,args:n,isBlocker:t});return a?(a.next=r,r.prev=a,a=r,o||(o=a)):o=a=r,l(),r.q.promise})}return r;function i(){const e={};return e.promise=new Promise((t,n)=>{e.resolve=t,e.reject=n}),e}function u({fn:e,args:t=[],isBlocker:n=!1,prev:r,next:o,q:a=i()}){return{fn:e,args:t,isBlocker:n,prev:r,next:o,q:a}}function l(){const e=o;if(!(!e||e.isBlocker&&e.prev||e.prev&&e.prev.isBlocker)){if(o=e.next,c)return e.q.reject(c),void t();e.fn(...e.args).then(e.q.resolve,e.q.reject).then(t),l()}function t(){e.prev&&(e.prev.next=e.next),e.next&&(e.next.prev=e.prev),a===e&&(a=null),l()}}}({init:function(){return s.startTransaction(["metadata"],"readonly",async e=>{const t=e.objectStore("metadata"),[n,o]=await Promise.all([r(t.getAllKeys()),r(t.getAll())]);for(let e=0;e<n.length;e++)i.set(n[e],u(o[e]))})},api:{set:function(e,n,r){return l(e,async o=>{if(o.meta){if("throw"===a)throw new Error(`idb-storage key conflict: ${e}`);if("ignore"===a)return o.meta;if("stack"===a)return await m(e,o)}"function"==typeof n&&({resource:n,meta:r}=await n()),r||(r={}),r.stack=0,t&&n instanceof Blob?(r.blobType=n.type,n=await function(e){return new Promise((t,n)=>{const r=new FileReader;r.onload=(()=>t(r.result)),r.onerror=n,r.readAsArrayBuffer(e)})}(n)):r.blobType=null,r.size=n.size||n.byteLength||n.length;const c=Object.assign({},o.meta,r);return await s.startTransaction(["metadata","resource"],"readwrite",t=>{const r=t.objectStore("metadata"),o=t.objectStore("resource");r.put(c,e),o.put(n,e)}),o.meta=c,c})},delete:function(e){return f([e])},deleteMany:function(e){return f(e)},get:function(e){return l(e,async t=>{if(!t.meta)throw new Error(`missing key: ${e}`);const n=await s.startTransaction(["resource"],"readonly",t=>{const n=t.objectStore("resource");return r(n.get(e))});return null!=t.meta.blobType?new Blob([n],t.meta.blobType):n})},getMeta:function(e){return l(e,t=>{if(!t.meta)throw new Error(`missing key: ${e}`);return t.meta})},stackUp:function(e){return l(e,t=>m(e,t))},clear:function(){return f([...i.keys()],!0)},clearAll:function(){const e=[...i.keys()];return d(e,async t=>{await s.startTransaction(["metadata","resource"],"readwrite",e=>{const t=e.objectStore("metadata"),n=e.objectStore("resource");t.clear(),n.clear()});for(let n=0;n<e.length;n++)t[n].lock.length>1?t[n].meta=null:i.delete(e[n])})}},block:["clearAll"]});function u(e){return{lock:n(),meta:e}}function l(e,t){let n=i.get(e);return n||(n=u(),i.set(e,n)),n.lock.use(()=>t(n))}async function d(e,t){const n=e.map(e=>{let t=i.get(e);return t||(t=u(),i.set(e,t)),t}),r=await Promise.all(n.map(e=>e.lock.acquire()));let o,a;try{a=await t(n)}catch(e){o=e}for(const e of r)e();if(o)throw o;return a}function f(e,t=!1){return d(e,async n=>{await s.startTransaction(["metadata","resource"],"readwrite",r=>{const o=r.objectStore("metadata"),a=r.objectStore("resource");for(let r=0;r<e.length;r++)(t||n[r].meta&&!n[r].meta.stack)&&(o.delete(e[r]),a.delete(e[r]))});for(let r=0;r<e.length;r++)!t&&n[r].meta&&n[r].meta.stack?n[r].meta.stack--:n[r].lock.length>1?n[r].meta=null:i.delete(e[r])})}async function m(e,t){if(!t.meta)throw new Error(`missing key: ${e}`);const n=Object.assign({},t.meta);return n.stack++,await s.startTransaction(["metadata"],"readwrite",t=>{t.objectStore("metadata").put(n,e)}),t.meta=n,n}},e.createLock=n,e}({});
