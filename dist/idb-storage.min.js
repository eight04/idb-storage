var idbStorage=function(e){"use strict";const t="undefined"!=typeof navigator&&/iP(hone|(o|a)d);/.test(navigator.userAgent);function n(){let e=Promise.resolve();const t={use:function(n){t.length++;const r=e.then(n).then(e=>(t.length--,e),e=>{throw t.length--,e});return e=r.catch(()=>{}),r},acquire:function(){let n;t.length++;const r=e.then(()=>n);return e=new Promise(e=>{n=e}).then(()=>{t.length--}),r},length:0};return t}function r(e){return new Promise((t,n)=>{e.onsuccess=(()=>t(e.result)),e.onerror=n})}function o({name:e,version:t,onupgradeneeded:n,indexedDB:r=a()}){if(!e)throw new Error("missing storage name");if(!r)throw new Error("missing indexedDB");let o,c=0;return{use:i,startTransaction:function(e,t,n){return i(async r=>{const o=r.transaction(e,t),[a]=await Promise.all([n(o),new Promise((e,t)=>{o.oncomplete=(()=>e()),o.onerror=t})]);return a})}};async function i(a){c++,o||(o=new Promise((o,a)=>{const c=r.open(e,t);c.onerror=a,c.onsuccess=(()=>o(c.result)),c.onupgradeneeded=n}));const i=await o;let s,u;try{u=await a(i)}catch(e){s=e}if(--c||(i.close(),o=null),s)throw s;return u}}function a(){return"undefined"!=typeof indexedDB?indexedDB:"undefined"!=typeof webkitIndexedDB?webkitIndexedDB:"undefined"!=typeof mozIndexedDB?mozIndexedDB:"undefined"!=typeof OIndexedDB?OIndexedDB:"undefined"!=typeof msIndexedDB?msIndexedDB:null}return e.createIDBStorage=function({name:e,conflictAction:a="throw",indexedDB:c}={}){const i=o({indexedDB:c,name:e,version:1,onupgradeneeded:function(e){e.oldVersion<1&&(e.target.result.createObjectStore("metadata"),e.target.result.createObjectStore("resource"))}}),s=new Map;let u;return function(e){for(const[t,n]of Object.entries(e))e[t]=(async(...e)=>(u||(u=i.startTransaction(["metadata"],"readonly",async e=>{const t=e.objectStore("metadata"),[n,o]=await Promise.all([r(t.getAllKeys()),r(t.getAll())]);for(let e=0;e<n.length;e++)s.set(n[e],d(o[e]))})),await u,await n(...e)));return e}({set:function(e,n,r){return l(e,async o=>{if(o.meta){if("throw"===a)throw new Error(`idb-storage key conflict: ${e}`);if("ignore"===a)return o.meta;if("stack"===a)return await m(e,o)}"function"==typeof n&&({resource:n,meta:r}=await n()),r||(r={}),r.stack=0,t&&n instanceof Blob?(r.blobType=n.type,n=await function(e){return new Promise((t,n)=>{const r=new FileReader;r.onload=(()=>t(r.result)),r.onerror=n,r.readAsArrayBuffer(e)})}(n)):r.blobType=null,r.size=n.size||n.byteLength||n.length;const c=Object.assign({},o.meta,r);return await i.startTransaction(["metadata","resource"],"readwrite",t=>{const r=t.objectStore("metadata"),o=t.objectStore("resource");r.put(c,e),o.put(n,e)}),o.meta=c,c})},delete:function(e){return f([e])},deleteMany:function(e){return f(e)},get:function(e){return l(e,async t=>{if(!t.meta)throw new Error(`missing key: ${e}`);const n=await i.startTransaction(["resource"],"readonly",t=>{const n=t.objectStore("resource");return r(n.get(e))});return null!=t.meta.blobType?new Blob([n],t.meta.blobType):n})},getMeta:function(e){return l(e,t=>{if(!t.meta)throw new Error(`missing key: ${e}`);return t.meta})},stackUp:function(e){return l(e,t=>m(e,t))},clear:function(){return f([...s.keys()],!0)}});function d(e){return{lock:n(),meta:e}}function l(e,t){let n=s.get(e);return n||(n=d(),s.set(e,n)),n.lock.use(()=>t(n))}function f(e,t=!1){return async function(e,t){const n=e.map(e=>{let t=s.get(e);return t||(t=d(),s.set(e,t)),t}),r=await Promise.all(n.map(e=>e.lock.acquire()));let o,a;try{a=await t(n)}catch(e){o=e}for(const e of r)e();if(o)throw o;return a}(e,async n=>{await i.startTransaction(["metadata","resource"],"readwrite",r=>{const o=r.objectStore("metadata"),a=r.objectStore("resource");for(let r=0;r<e.length;r++)(t||n[r].meta&&!n[r].meta.stack)&&(o.delete(e[r]),a.delete(e[r]))});for(let r=0;r<e.length;r++)!t&&n[r].meta&&n[r].meta.stack?n[r].meta.stack--:n[r].lock.length>1?n[r].meta=null:s.delete(e[r])})}async function m(e,t){if(!t.meta)throw new Error(`missing key: ${e}`);const n=Object.assign({},t.meta);return n.stack++,await i.startTransaction(["metadata"],"readwrite",t=>{t.objectStore("metadata").put(n,e)}),t.meta=n,n}},e.createLock=n,e}({});
